name: EditorConfig Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

jobs:
  check-editorconfig:
    runs-on: ubuntu-latest
    
    steps:
    # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
    - name: Checkout code
      uses: actions/checkout@v3
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º EditorConfig
    - name: Check EditorConfig compliance
      id: editorconfig-check
      run: |
        echo "üîç –ù–∞—á–∏–Ω–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É EditorConfig..."
        
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
        
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .editorconfig
        if [ ! -f ".editorconfig" ]; then
          echo "‚ùå –§–∞–π–ª .editorconfig –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "result=error" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ .sh —Ñ–∞–π–ª–∞—Ö (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 2 –ø—Ä–æ–±–µ–ª–∞)
        echo "üìù –ü—Ä–æ–≤–µ—Ä—è—é .sh —Ñ–∞–π–ª—ã..."
        ERROR_COUNT=0
        
        for file in *.sh; do
          if [ -f "$file" ]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±—ã (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)
            if grep -q $'\t' "$file"; then
              echo "  ‚ùå $file: –Ω–∞–π–¥–µ–Ω —Ç–∞–± (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ–±–µ–ª—ã)"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          fi
        done
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º .yml —Ñ–∞–π–ª—ã
        for file in .github/workflows/*.yml .github/workflows/*.yaml; do
          if [ -f "$file" ]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç—Å—Ç—É–ø—ã = 2 –ø—Ä–æ–±–µ–ª–∞
            if grep -q '^   [^ ]' "$file"; then
              echo "  ‚ö†Ô∏è  $file: –≤–æ–∑–º–æ–∂–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 2 –ø—Ä–æ–±–µ–ª–∞)"
            fi
          fi
        done
        
        # 4. –ò—Ç–æ–≥
        if [ $ERROR_COUNT -eq 0 ]; then
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "‚ùå –ù–∞–π–¥–µ–Ω–æ $ERROR_COUNT –æ—à–∏–±–æ–∫"
          echo "result=failure" >> $GITHUB_OUTPUT
        fi
    
    # 3. –°–æ–∑–¥–∞—ë–º –±–µ–π–¥–∂
    - name: Create status badge
      if: always()
      run: |
        echo "üõ°Ô∏è –°–æ–∑–¥–∞—é –±–µ–π–¥–∂ —Å—Ç–∞—Ç—É—Å–∞..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ —Ç–µ–∫—Å—Ç –±–µ–π–¥–∂–∞
        if [ "${{ steps.editorconfig-check.outputs.result }}" == "success" ]; then
          BADGE_LABEL="EditorConfig"
          BADGE_MESSAGE="–ø—Ä–æ–π–¥–µ–Ω–∞"
          BADGE_COLOR="brightgreen"
          STATUS="‚úÖ"
        elif [ "${{ steps.editorconfig-check.outputs.result }}" == "failure" ]; then
          BADGE_LABEL="EditorConfig"
          BADGE_MESSAGE="–æ—à–∏–±–∫–∏"
          BADGE_COLOR="red"
          STATUS="‚ùå"
        else
          BADGE_LABEL="EditorConfig"
          BADGE_MESSAGE="–ø—Ä–æ–≤–µ—Ä–∫–∞"
          BADGE_COLOR="blue"
          STATUS="üîµ"
        fi
        
        # –°–æ–∑–¥–∞—ë–º URL –¥–ª—è –±–µ–π–¥–∂–∞ shields.io
        BADGE_URL="https://img.shields.io/badge/$BADGE_LABEL-$BADGE_MESSAGE-$BADGE_COLOR"
        
        # –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —Å –±–µ–π–¥–∂–µ–º
        echo "![EditorConfig Check]($BADGE_URL)" > editorconfig-badge.md
        
        # –û–±–Ω–æ–≤–ª—è–µ–º README.md –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if [ -f "README.md" ]; then
          echo "üìÑ –û–±–Ω–æ–≤–ª—è—é README.md..."
          
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –±–µ–π–¥–∂ –µ—Å–ª–∏ –µ—Å—Ç—å
          sed -i '/!\[EditorConfig Check\]/d' README.md
          
          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–µ–π–¥–∂ –≤ –∫–æ–Ω–µ—Ü
          echo "" >> README.md
          echo "## üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏" >> README.md
          echo "" >> README.md
          echo "$STATUS **EditorConfig:** ![EditorConfig Check]($BADGE_URL)" >> README.md
          echo "" >> README.md
          echo "*–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: $(date +'%Y-%m-%d %H:%M')*" >> README.md
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–∏
          echo "--- –î–û–ë–ê–í–õ–ï–ù–û –í README.md ---"
          tail -10 README.md
          echo "-----------------------------"
        fi
        
        echo "‚úÖ –ë–µ–π–¥–∂ —Å–æ–∑–¥–∞–Ω: $BADGE_URL"
    
    # 4. –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ README –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    - name: Commit badge changes
      if: always()
      run: |
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
        if git diff --quiet README.md; then
          echo "üìù –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          echo "üìù –ö–æ–º–º–∏—á—É –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ README.md..."
          git add README.md
          git commit -m "docs: update EditorConfig badge [skip ci]"
          git push
        fi
    
    # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: editorconfig-results
        path: |
          editorconfig-badge.md
        retention-days: 7
